---
# Notes to maintainers:
#
# 1. It's probably good to read the following before attempting changes:
#    https://observablehq.com/framework/markdown
#    https://observablehq.com/framework/javascript
#    https://observablehq.com/framework/reactivity
#    https://observablehq.com/@observablehq/htl
#    https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise
#
# 2. We use quite a lot of HTML to leverage the GOV.UK Design System, more than most Observable
#    Framework examples, which means you probably want to add blank lines for readability. But be
#    careful! In normal HTML this has no effect, but here it runs the risk of being parsed as
#    Markdown, and if too intented will be treated as a code block to display.
#
#    We have worked around this by using empty HTML comments <-- --> to add in some whitespace.

# Title is empty since this is a single page site, and the <title> element will contain the site name
title: {{ country.Display }}
toc: false
theme: air
---

<!-- Initialise govuk-frontend -->
```js
import { initAll } from 'npm:govuk-frontend@5.8.0/dist/govuk/govuk-frontend.min.js'
initAll();
````

<!-- Constants -->
```js
const govuk_colour_palette = ["#F46A25", "#28A197", "#12436D", "#801650", "#3D3D3D", "#A285D1"];
```

<!-- Data -->
```js
const tradeTotals = await FileAttachment("../data/uk-total-trade-all-countries-seasonally-adjusted.csv").csv({typed: true});
const spainTotals = await tradeTotals.filter(row => row['Year'] >= 2014 && row['ISO2'] === '{{ country.ISO2 }}' && (row['flow'] == 'total_import' || row['flow'] == 'total_export'));
```

<!-- Input widgets -->
```js
// None at the moment
```

<!-- Charts -->
```js
function tradeValue(data) {
  return Plot.plot({
    subtitle: "",
    style: "font-size: 16px;",
    marginLeft: 40,
    marginBottom: 40,
    marginTop: 30,
    x: {label: null, tickRotate: -45, type: "band"},
    y: {label: "£ Billion", grid: true, nice: true},
    color: {
      range: govuk_colour_palette,
    },
    marks: [
      Plot.gridY(),
      Plot.ruleY([0], {stroke: "#b1b4b6", strokeWidth: 4}),
      Plot.line(data, {
        y: d => d['Million'] / 1000.0,
        x: d => '' + d['Year'],
        z: d => d['flow'],
        stroke: d => d["flow"],
        strokeWidth: 5,
      }),
      Plot.line(data, Plot.groupX({
        y: "sum",
      }, {
        y: d => d['Million'] / 1000.0,
        x: d => '' + d['Year'],
        stroke: 2,
        strokeWidth: 6,
      })),
    ]
  })
};

function tradeBalance(data) {
  return Plot.plot({
    subtitle: "",
    style: "font-size: 16px;",
    marginLeft: 40,
    marginBottom: 40,
    marginTop: 30,
    x: {label: null, tickRotate: -45, type: "band"},
    y: {label: "£ Billion", grid: true, nice: true},
    marks: [ 
      Plot.gridY(),
      Plot.ruleY([0], {stroke: "#b1b4b6", strokeWidth: 4}),
      Plot.barY(data, Plot.groupX({
        y: "sum",
      }, {
        x: d => '' + d['Year'],
        y: d => d['Million'] * (d['flow'] == 'total_import' ? -1 : 1) / 1000.0,
        fill: govuk_colour_palette[2],
      })),
      Plot.ruleY([0], {stroke: "currentColor"}),
    ]
  })
};

function table(data) {
  const dataByYearAndFlow = d3.group(data, d => d.Year, d => d.flow);
  console.log(dataByYearAndFlow)
  return htl.html`<table class="govuk-table">
    <caption class="govuk-table__caption govuk-table__caption--m">UK trade with {{ country.Display }}</caption>
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th scope="col" class="govuk-table__header">Value in £bn</th>
        ${dataByYearAndFlow.keys().map((year) =>
          htl.html`<th scope="col" class="govuk-table__header govuk-table__header--numeric">${year}</th>`
        )}
      </tr>
    </thead>
    <tbody class="govuk-table__body">
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">Total trade</th>
        ${dataByYearAndFlow.entries().map((entry) =>
          htl.html`<td class="govuk-table__cell govuk-table__cell--numeric">${((entry[1].get('total_export')[0]['Million'] + entry[1].get('total_import')[0]['Million']) / 1000.0).toFixed(1)}</td>`
        )}
      </tr>
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">Exports</th>
        ${dataByYearAndFlow.entries().map((entry) =>
          htl.html`<td class="govuk-table__cell govuk-table__cell--numeric">${((entry[1].get('total_export')[0]['Million']) / 1000.0).toFixed(1)}</td>`
        )}
      </tr>
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">Imports</th>
        ${dataByYearAndFlow.entries().map((entry) =>
          htl.html`<td class="govuk-table__cell govuk-table__cell--numeric">${((entry[1].get('total_import')[0]['Million']) / 1000.0).toFixed(1)}</td>`
        )}
      </tr>
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">Trade balance</th>
        ${dataByYearAndFlow.entries().map((entry) =>
          htl.html`<td class="govuk-table__cell govuk-table__cell--numeric">${((entry[1].get('total_export')[0]['Million'] - entry[1].get('total_import')[0]['Million']) / 1000.0).toFixed(1)}</td>`
        )}
      </tr>
    </tbody>
  </table>
  `
}
```

<!-- HTML combining all the above -->
<div class="govuk-width-container">
  <nav class="govuk-breadcrumbs" aria-label="Breadcrumb">
  <ol class="govuk-breadcrumbs__list">
    <li class="govuk-breadcrumbs__list-item">
      <a class="govuk-breadcrumbs__link" href="../">Home</a>
    </li>
    <li class="govuk-breadcrumbs__list-item">
      <a class="govuk-breadcrumbs__link" href="/partners/{{ country.Display }}">{{ country.Display }}</a>
    </li>
  </ol>
  </nav>
  <div class="govuk-main-wrapper">
  <span class="govuk-caption-l">Trade and investment factsheets</span>
  <h1 class="govuk-heading-l">{{ country.Display }}</h1>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <p class="govuk-body-l govuk-!-margin-bottom-0">Snapshot of the latest statistics on trade and investment between the UK and {{ country.Display }}.</p>
    </div>
  </div>
  <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-third">
          <p class="govuk-body-s">
            <strong>Release date:</strong><br>
            20 December 2024
          </p>
        </div>
        <div class="govuk-grid-column-one-third">
          <p class="govuk-body-s">
            <strong>Next planned release:</strong><br>
            31 January 2025
          </p>
        </div>
      </div>
    </div>
  </div>
  <h2 class="govuk-heading-m govuk-!-margin-top-2">Trade with {{ country.Display }}, in current prices (ONS)</h1>
  <div class="taif-card">
    <h3 class="govuk-heading-s">UK trade with {{ country.Display }}</h2>
    <div class="govuk-tabs govuk-!-margin-bottom-0" data-module="govuk-tabs">
      <h4 class="govuk-tabs__title">
        Contents
      </h4>
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#chart">
            Chart
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#tabular-data">
            Tabular data
          </a>
        </li>
      </ul>
      <div class="govuk-tabs__panel" id="chart">
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-one-half">
            <h5><span class="govuk-heading-s">Trade value</span></h5>
            ${tradeValue(spainTotals)}
          </div>
          <div class="govuk-grid-column-one-half">
            <h5><span class="govuk-heading-s">Trade balance</span></h5>
            ${tradeBalance(spainTotals)}
          </div>
        </div>
      </div>
      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="tabular-data">
        ${table(spainTotals)}
      </div>
    </div>
  </div>
<!-- Closes .govuk-width-container and .govuk-main-wrapper -->
</div></div>
